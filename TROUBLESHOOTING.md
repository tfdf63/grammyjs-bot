# Руководство по устранению неполадок

## Проблема: Бот перезапускается 140+ раз и падает

### Основные причины:

1. **Конфликт нескольких экземпляров бота (409 Conflict)**
2. **Ошибки с каналом (400 Bad Request: chat not found)**
3. **Истекшие сессии API (Expired Session ID)**
4. **Необработанные Promise rejections**

### Решения:

#### 1. Проверка и остановка дублирующихся процессов

```bash
# Запустите скрипт для проверки дубликатов
npm run pm2:check-duplicates

# Или вручную:
pm2 list
pm2 stop tg-grammy-tickets-bot
pm2 delete tg-grammy-tickets-bot
pm2 start ecosystem.config.js
```

#### 2. Проверка переменных окружения

Убедитесь, что в файле `.env` на сервере есть все необходимые переменные:

```env
BOT_API_KEY=your_telegram_bot_token
BOT_TICKETS_LOGIN=your_login
BOT_TICKETS_PASSWORD=your_password
CHANNEL_ID=-1002396067751
```

#### 3. Проверка доступа к каналу

Убедитесь, что:

- Бот добавлен в канал
- У бота есть права на отправку сообщений
- ID канала указан правильно

#### 4. Обновление сессий API

Если появляются ошибки "Expired Session ID", может потребоваться обновить логин/пароль для API билетов.

#### 5. Мониторинг логов

```bash
# Просмотр логов в реальном времени
npm run pm2:logs

# Мониторинг процессов
npm run pm2:monit
```

### Команды для управления:

```bash
# Запуск бота
npm run pm2:start

# Остановка бота
npm run pm2:stop

# Перезапуск бота
npm run pm2:restart

# Удаление бота из PM2
npm run pm2:delete

# Проверка дубликатов
npm run pm2:check-duplicates
```

### Профилактика:

1. **Регулярно проверяйте логи** на наличие ошибок
2. **Используйте скрипт проверки дубликатов** перед запуском
3. **Мониторьте использование памяти** (лимит установлен на 1GB)
4. **Проверяйте доступность API** билетов

### Дополнительные настройки PM2:

В `ecosystem.config.js` добавлены настройки:

- `unique: true` - предотвращает дублирование
- `kill_timeout: 5000` - время ожидания перед принудительной остановкой
- `wait_ready: true` - ждет сигнал готовности от приложения
- `listen_timeout: 10000` - таймаут ожидания готовности
